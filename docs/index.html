<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å€‹è‚¡æœŸè²¨ç›£æ§é é¢</title>
  <style>
    body { background: #0b0f14; color: #e8eef6; font-family: sans-serif; padding: 20px; line-height: 1.5; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
    .card { background: #101824; border: 1px solid #203044; border-radius: 12px; padding: 20px; }
    .net-up { color: #ff7676; font-weight: bold; }
    .net-down { color: #52ff94; font-weight: bold; }
    .muted { color: #9fb1c6; }
    .bad { color: #ffb4b4; padding: 10px; border: 1px dashed #442222; border-radius: 8px; }
    h3 { margin: 0 0 10px 0; border-bottom: 1px solid #22334a; padding-bottom: 8px; }

    .section { margin-top: 18px; }
    .section h2 { margin: 0 0 10px 0; font-size: 1.1rem; }
    .trend-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; }
    .trend-table { width: 100%; border-collapse: collapse; font-size: 0.92em; }
    .trend-table th, .trend-table td { padding: 6px 8px; border-bottom: 1px solid #22334a; }
    .trend-table th { text-align: left; color: #9fb1c6; font-weight: 600; }
    .right { text-align: right; }
    .tiny { font-size: 0.85em; }
  </style>
</head>
<body>
  <h1>ğŸ“Š å€‹è‚¡æœŸè²¨å¤§é¡äº¤æ˜“äººç›£æ§</h1>
  <p id="meta" class="muted">æ­£åœ¨è¼‰å…¥æ•¸æ“š.</p>

  <div id="grid" class="grid"></div>

  <div class="section">
    <h2>ğŸ“ˆ è¿‘ 7 æ—¥è®ŠåŒ–ï¼ˆè‡ªå‹•ç´¯ç©ï¼‰</h2>
    <p id="trendHint" class="muted tiny">å¦‚æœé€™è£¡é‚„æ²’æœ‰è³‡æ–™ï¼šä»£è¡¨ä½ å°šæœªç´¯ç©åˆ° 2 å¤©ä»¥ä¸Šï¼ˆç­‰ Actions æ˜å¤©å†è·‘ä¸€æ¬¡ï¼‰ã€‚</p>
    <div id="trend" class="trend-grid"></div>
  </div>

  <script>
    function fmtSigned(n) {
      if (typeof n !== 'number' || Number.isNaN(n)) return '-';
      return (n > 0 ? '+' : '') + n;
    }

    function clsByNet(n) {
      return (typeof n === 'number' && n >= 0) ? 'net-up' : 'net-down';
    }

    function fmtDate(yyyymmdd) {
      if (!yyyymmdd) return '-';
      const s = String(yyyymmdd);
      if (s.length === 8) return s.slice(4,6) + '/' + s.slice(6,8);
      return s;
    }

    function pickItem(day, ticker) {
      const items = (day && Array.isArray(day.items)) ? day.items : [];
      return items.find(x => String(x.ticker) === String(ticker)) || null;
    }

    function safeNumber(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    async function load() {
      try {
        const resp = await fetch('./futures_data.json?v=' + Date.now());
        if (!resp.ok) throw new Error('æ‰¾ä¸åˆ° futures_data.json');
        const d = await resp.json();

        document.getElementById('meta').innerText =
          `æ•¸æ“šæ—¥æœŸï¼š${d.date || '-'}ï¼ˆæ¯æ—¥ 16:00 å¾Œè‡ªå‹•æ›´æ–°ï¼‰`;

        // ä»Šæ—¥å¡ç‰‡
        document.getElementById('grid').innerHTML = (d.items || []).map(it => {
          const res = (it && it.data) ? it.data : { error: 'è³‡æ–™æ ¼å¼ç•°å¸¸' };
          if (res.error) return `<div class="card"><h3>${it.name || '-'}</h3><p class="bad">${res.error}</p></div>`;

          return `
            <div class="card">
              <h3>${it.name} (${it.ticker})</h3>
              <p>å‰äº”å¤§æ·¨éƒ¨ä½ï¼š<span class="${clsByNet(res.top5.net)}">${fmtSigned(res.top5.net)}</span></p>
              <p>å‰åå¤§æ·¨éƒ¨ä½ï¼š<span class="${clsByNet(res.top10.net)}">${fmtSigned(res.top10.net)}</span></p>
              <div class="muted" style="margin-top:12px; font-size: 0.9em;">
                <div>äº”å¤§å¤š/ç©ºï¼š${res.top5.buy} / ${res.top5.sell}</div>
                <div>åå¤§å¤š/ç©ºï¼š${res.top10.buy} / ${res.top10.sell}</div>
                <div>ç¸½æœªå¹³å€‰é‡ï¼š${res.oi}</div>
              </div>
            </div>`;
        }).join('');

        // è¿‘ 7 æ—¥ï¼ˆhistoryï¼‰
        const history = Array.isArray(d.history) ? d.history : [];
        if (!history.length) {
          document.getElementById('trend').innerHTML = '';
          document.getElementById('trendHint').style.display = '';
          return;
        }

        document.getElementById('trendHint').style.display = 'none';

        const targets = Array.isArray(d.items) ? d.items : [];
        document.getElementById('trend').innerHTML = targets.map(t => {
          const ticker = t.ticker;
          const name = t.name || ticker;

          const rows = history.map((day, idx) => {
            const it = pickItem(day, ticker);
            const res = (it && it.data && !it.data.error) ? it.data : null;

            const top5 = res ? safeNumber(res.top5?.net) : null;
            const top10 = res ? safeNumber(res.top10?.net) : null;
            const oi = res ? safeNumber(res.oi) : null;

            // è·Ÿã€Œä¸‹ä¸€å¤©ï¼ˆæ›´èˆŠï¼‰ã€æ¯”ï¼šé¡¯ç¤ºäº”å¤§æ·¨è®ŠåŒ–
            const nextDay = history[idx + 1];
            const nextIt = nextDay ? pickItem(nextDay, ticker) : null;
            const nextRes = (nextIt && nextIt.data && !nextIt.data.error) ? nextIt.data : null;
            const nextTop5 = nextRes ? safeNumber(nextRes.top5?.net) : null;
            const dTop5 = (top5 !== null && nextTop5 !== null) ? (top5 - nextTop5) : null;
            const deltaTxt = (dTop5 === null) ? '' : ` <span class="muted tiny">(${dTop5>0?'+':''}${dTop5})</span>`;

            return `
              <tr>
                <td class="muted">${fmtDate(day.date)}</td>
                <td class="right"><span class="${top5 === null ? 'muted' : clsByNet(top5)}">${top5 === null ? '-' : fmtSigned(top5)}</span>${deltaTxt}</td>
                <td class="right"><span class="${top10 === null ? 'muted' : clsByNet(top10)}">${top10 === null ? '-' : fmtSigned(top10)}</span></td>
                <td class="right"><span class="${oi === null ? 'muted' : ''}">${oi === null ? '-' : oi}</span></td>
              </tr>`;
          }).join('');

          return `
            <div class="card">
              <h3>${name} (${ticker})</h3>
              <table class="trend-table">
                <thead>
                  <tr>
                    <th>æ—¥æœŸ</th>
                    <th class="right">äº”å¤§æ·¨</th>
                    <th class="right">åå¤§æ·¨</th>
                    <th class="right">OI</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
              <div class="muted tiny" style="margin-top:10px;">äº”å¤§æ·¨å¾Œé¢æ‹¬è™Ÿæ˜¯ã€Œæ¯”å‰ä¸€æ—¥å¢åŠ /æ¸›å°‘ã€ã€‚</div>
            </div>`;
        }).join('');

      } catch (e) {
        document.getElementById('meta').innerHTML =
          '<span class="bad">å°šæœªåµæ¸¬åˆ°æ•¸æ“šã€‚è«‹ç¢ºèª futures_data.json æ˜¯å¦å­˜åœ¨ã€ä»¥åŠ Actions æ˜¯å¦æˆåŠŸå¯«å…¥ã€‚</span>';
        document.getElementById('trend').innerHTML = '';
      }
    }

    load();
  </script>
</body>
</html>
